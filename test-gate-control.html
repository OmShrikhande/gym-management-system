<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Control Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .success {
            color: #28a745;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #17a2b8;
            background-color: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        h1, h2 {
            color: #333;
        }
    </style>
</head>
<body>
    <h1>üö™ Gate Control Test</h1>
    
    <div class="container">
        <h2>Authentication</h2>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Enter your password">
        </div>
        <div class="form-group">
            <label for="userType">User Type:</label>
            <select id="userType">
                <option value="gym-owner">Gym Owner</option>
                <option value="trainer">Trainer</option>
            </select>
        </div>
        <button onclick="authenticate()">üîê Login</button>
        <div id="authResult"></div>
    </div>

    <div class="container">
        <h2>Gate Control</h2>
        <button onclick="openGate()" id="openGateBtn" disabled>üö™ Open Gate</button>
        <button onclick="closeGate()" id="closeGateBtn" disabled>üîí Close Gate</button>
        <button onclick="emergencyGate()" id="emergencyBtn" disabled>üö® Emergency Open</button>
        <button onclick="checkStatus()" id="statusBtn" disabled>üìä Check Status</button>
        <div id="gateResult"></div>
    </div>

    <div class="container">
        <h2>Debug Information</h2>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        const API_URL = 'https://gym-management-system-ckb0.onrender.com/api';
        let currentToken = null;
        let currentUser = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const colorMap = {
                'info': '#17a2b8',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colorMap[type] || '#333'}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${isSuccess ? 'success' : 'error'}">${message}</div>`;
        }

        async function makeRequest(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (currentToken) {
                options.headers['Authorization'] = `Bearer ${currentToken}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            log(`Making ${method} request to ${endpoint}`, 'info');
            if (data) {
                log(`Request data: ${JSON.stringify(data, null, 2)}`, 'info');
            }

            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const result = await response.json();
                
                log(`Response (${response.status}): ${JSON.stringify(result, null, 2)}`, response.ok ? 'success' : 'error');
                
                return { success: response.ok, data: result, status: response.status };
            } catch (error) {
                log(`Request failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function authenticate() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;

            if (!email || !password) {
                showResult('authResult', 'Please enter email and password', false);
                return;
            }

            log(`Attempting authentication for ${userType}: ${email}`, 'info');

            const result = await makeRequest('/auth/login', 'POST', {
                email: email,
                password: password
            });

            if (result.success && result.data.token) {
                currentToken = result.data.token;
                currentUser = result.data.user;
                
                showResult('authResult', `‚úÖ Authentication successful! Welcome ${currentUser.name} (${currentUser.role})`, true);
                
                // Enable gate control buttons
                document.getElementById('openGateBtn').disabled = false;
                document.getElementById('closeGateBtn').disabled = false;
                document.getElementById('emergencyBtn').disabled = false;
                document.getElementById('statusBtn').disabled = false;

                log(`User authenticated: ${JSON.stringify({
                    id: currentUser._id,
                    name: currentUser.name,
                    role: currentUser.role,
                    gymId: currentUser.gymId
                }, null, 2)}`, 'success');

            } else {
                showResult('authResult', `‚ùå Authentication failed: ${result.data?.message || result.error}`, false);
                currentToken = null;
                currentUser = null;
            }
        }

        async function openGate() {
            if (!currentToken) {
                showResult('gateResult', 'Please login first', false);
                return;
            }

            log('Attempting to open gate...', 'info');
            const result = await makeRequest('/gate/toggle', 'POST', { status: true });

            if (result.success) {
                showResult('gateResult', `‚úÖ Gate opened successfully!`, true);
                log('Gate opened successfully', 'success');
            } else {
                showResult('gateResult', `‚ùå Failed to open gate: ${result.data?.message || result.error}`, false);
                log(`Gate opening failed: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function closeGate() {
            if (!currentToken) {
                showResult('gateResult', 'Please login first', false);
                return;
            }

            log('Attempting to close gate...', 'info');
            const result = await makeRequest('/gate/toggle', 'POST', { status: false });

            if (result.success) {
                showResult('gateResult', `‚úÖ Gate closed successfully!`, true);
                log('Gate closed successfully', 'success');
            } else {
                showResult('gateResult', `‚ùå Failed to close gate: ${result.data?.message || result.error}`, false);
                log(`Gate closing failed: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function emergencyGate() {
            if (!currentToken) {
                showResult('gateResult', 'Please login first', false);
                return;
            }

            const reason = prompt('Enter reason for emergency access:') || 'Emergency access test';
            
            log(`Attempting emergency gate access with reason: ${reason}`, 'warning');
            const result = await makeRequest('/gate/emergency', 'POST', { reason });

            if (result.success) {
                showResult('gateResult', `üö® Emergency gate access granted!`, true);
                log('Emergency gate access successful', 'success');
            } else {
                showResult('gateResult', `‚ùå Emergency access failed: ${result.data?.message || result.error}`, false);
                log(`Emergency access failed: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function checkStatus() {
            if (!currentToken) {
                showResult('gateResult', 'Please login first', false);
                return;
            }

            log('Checking gate status...', 'info');
            const result = await makeRequest('/gate/status', 'GET');

            if (result.success) {
                showResult('gateResult', `üìä Gate status retrieved successfully`, true);
                log('Gate status check successful', 'success');
            } else {
                showResult('gateResult', `‚ùå Failed to get gate status: ${result.data?.message || result.error}`, false);
                log(`Gate status check failed: ${result.data?.message || result.error}`, 'error');
            }
        }

        // Initialize
        log('Gate Control Test initialized', 'info');
        log('Please enter your credentials and click Login to start testing', 'info');
    </script>
</body>
</html>